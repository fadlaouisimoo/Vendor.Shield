<% if (pendingCount > 0 && !notificationRead) { %>
	<div id="notification-banner" class="notification-banner" style="background:linear-gradient(135deg,rgba(245,158,11,.15),rgba(251,146,60,.1));border:1px solid rgba(245,158,11,.3);border-radius:12px;padding:16px;margin-bottom:24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
		<div style="display:flex;align-items:center;gap:12px">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
				<path d="M13.73 21a2 2 0 0 1-3.46 0"/>
			</svg>
			<div>
				<p style="color:var(--text);font-weight:600;margin:0;font-size:16px">
					<%= lang === 'en' ? 'New Assessment' : 'Nouvelle évaluation' %>
					<span class="badge warn" style="margin-left:8px;background:linear-gradient(180deg,rgba(154,52,18,.9),rgba(194,65,12,.7));">
						<%= pendingCount %>
					</span>
				</p>
				<p style="color:var(--muted);font-size:13px;margin:4px 0 0 0">
					<%= lang === 'en' ? 'Assessment(s) pending validation' : 'Évaluation(s) en attente de validation' %>
				</p>
			</div>
		</div>
		<div style="display:flex;align-items:center;gap:8px">
			<a href="#suppliers-table" class="btn" style="display:inline-flex;align-items:center;gap:6px">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<polyline points="6 9 12 15 18 9"/>
				</svg>
				<%= lang === 'en' ? 'View' : 'Voir' %>
			</a>
			<button id="mark-read-btn" class="btn mark-read-btn" style="display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,rgba(34,197,94,.15),rgba(22,163,74,.1));border:1px solid rgba(34,197,94,.3);color:#22c55e;">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<polyline points="20 6 9 17 4 12"/>
				</svg>
				<%= t('common.markAsRead') %>
			</button>
		</div>
	</div>
<% } %>

<h2 id="suppliers-table"><%= t('common.suppliers') %></h2>

<table class="table">
	<thead>
		<tr>
			<th><%= t('common.name') %></th>
			<th><%= t('common.email') %></th>
			<th><%= t('common.score') %></th>
			<th><%= t('common.status') %></th>
			<th>Actions</th>
		</tr>
	</thead>
	<tbody>
		<% if (!suppliers || suppliers.length === 0) { %>
			<tr><td colspan="5" class="muted"><%= lang === 'en' ? 'No suppliers' : 'Aucun fournisseur' %></td></tr>
		<% } %>
		<% (suppliers || []).forEach(s => { %>
			<% 
			// Use statusKey to determine badge type (s.statusKey is set in app.js)
			const statusKey = s.statusKey || (s.status === 'COMPLIANT' || s.status === 'Conforme' || s.status === 'Compliant' ? 'COMPLIANT' 
				: (s.status === 'IN_PROGRESS' || s.status === 'En cours' || s.status === 'In Progress' ? 'IN_PROGRESS' : 'NON_COMPLIANT'));
			const isCompliant = statusKey === 'COMPLIANT';
			const isInProgress = statusKey === 'IN_PROGRESS';
			// Status text is already translated in app.js
			const statusText = s.status;
			%>
			<tr>
				<td data-label="<%= t('common.name') %>"><a href="<%= urlWithLang('/suppliers/' + s.id) %>"><%= s.name %></a></td>
				<td data-label="<%= t('common.email') %>"><%= s.contact_email || '-' %></td>
				<td data-label="<%= t('common.score') %>"><strong><%= s.score %>%</strong></td>
				<td class="status-cell" data-label="<%= t('common.status') %>">
					<span class="badge <%= isCompliant ? 'ok' : (isInProgress ? 'warn' : 'err') %>">
						<% if (isCompliant) { %>
							<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><polyline points="20 6 9 17 4 12"/></svg>
						<% } else if (isInProgress) { %>
							<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
						<% } else { %>
							<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
						<% } %>
						<%= statusText %>
					</span>
				</td>
				<td class="actions-cell" data-label="Actions">
					<div class="actions-wrapper">
						<a class="btn action" href="<%= baseUrl %>/invite/<%= s.invite_token %>" target="_blank"><%= t('common.inviteLink') %></a>
						<form method="post" action="<%= urlWithLang('/suppliers/' + s.id + '/delete') %>" style="margin:0;padding:0;display:flex" onsubmit="return confirm('<%= t('delete.confirm') %>');">
							<button class="btn action" type="submit" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border:none;font-family:inherit"><%= t('common.delete') %></button>
						</form>
					</div>
				</td>
			</tr>
		<% }) %>
	</tbody>
</table>

<section class="kpis">
	<div class="kpi">
		<div class="kpi-label"><%= lang === 'en' ? '% Compliant' : '% conformes' %></div>
		<div class="kpi-value">
			<% const nb = (suppliers || []).length; const nbOk = (suppliers || []).filter(x => (x.statusKey || 'IN_PROGRESS') === 'COMPLIANT').length; const pct = nb ? Math.round((nbOk/nb)*100) : 0; %>
			<%= pct %>%
		</div>
	</div>
	<div class="kpi">
		<div class="kpi-label"><%= lang === 'en' ? 'Critical Risks' : 'Risques critiques identifiés' %></div>
		<div class="kpi-value">
			<% const nbCrit = (suppliers || []).filter(x => (x.statusKey || 'IN_PROGRESS') === 'NON_COMPLIANT').length; %>
			<%= nbCrit %>
		</div>
	</div>
	<div class="kpi">
		<div class="kpi-label"><%= lang === 'en' ? 'Average Compliance Time' : 'Délai moyen de mise en conformité' %></div>
		<div class="kpi-value">
			<%= typeof averageComplianceDays !== 'undefined' && averageComplianceDays > 0 ? averageComplianceDays : '-' %>
			<% if (typeof averageComplianceDays !== 'undefined' && averageComplianceDays > 0) { %>
				<span style="font-size:14px;font-weight:400;opacity:0.7"><%= lang === 'en' ? 'days' : 'jours' %></span>
			<% } %>
		</div>
	</div>
	<div class="kpi" style="<%= pendingCount > 0 ? 'border-color: #f59e0b; box-shadow: 0 0 0 2px rgba(245,158,11,0.2)' : '' %>">
		<div class="kpi-label"><%= lang === 'en' ? 'Pending Validation' : 'En attente de validation' %></div>
		<div class="kpi-value" style="<%= pendingCount > 0 ? 'color: #f59e0b' : '' %>">
			<%= pendingCount || 0 %>
		</div>
	</div>
</section>

<!-- Charts Section -->
<section class="charts-section" style="margin-top:32px;display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px">
	<!-- Compliance Status Chart -->
	<div class="chart-container" style="background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:14px;padding:20px">
		<h3 style="margin:0 0 16px 0;font-size:16px;color:var(--text)"><%= lang === 'en' ? 'Compliance Status Distribution' : 'Répartition des statuts de conformité' %></h3>
		<canvas id="statusChart" style="max-height:300px"></canvas>
	</div>
	
	<!-- Compliance Percentage Chart -->
	<div class="chart-container" style="background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:14px;padding:20px">
		<h3 style="margin:0 0 16px 0;font-size:16px;color:var(--text)"><%= lang === 'en' ? 'Compliance Rate' : 'Taux de conformité' %></h3>
		<canvas id="complianceChart" style="max-height:300px"></canvas>
	</div>
	
	<!-- Risks Chart -->
	<div class="chart-container" style="background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:14px;padding:20px">
		<h3 style="margin:0 0 16px 0;font-size:16px;color:var(--text)"><%= lang === 'en' ? 'Risk Overview' : 'Vue d\'ensemble des risques' %></h3>
		<canvas id="risksChart" style="max-height:300px"></canvas>
	</div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
	const markReadBtn = document.getElementById('mark-read-btn');
	const notificationBanner = document.getElementById('notification-banner');
	
	if (markReadBtn && notificationBanner) {
		markReadBtn.addEventListener('click', async function() {
			// Disable button during request
			markReadBtn.disabled = true;
			markReadBtn.style.opacity = '0.6';
			markReadBtn.style.cursor = 'not-allowed';
			
			try {
				const response = await fetch('<%= urlWithLang("/admin/notification/mark-read") %>', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					}
				});
				
				if (response.ok) {
					// Start fade out animation
					notificationBanner.style.opacity = '0';
					notificationBanner.style.transform = 'translateY(-20px) scale(0.95)';
					notificationBanner.style.marginBottom = '0';
					
					// Remove from DOM after animation
					setTimeout(() => {
						notificationBanner.style.display = 'none';
					}, 400);
				} else {
					// Re-enable button on error
					markReadBtn.disabled = false;
					markReadBtn.style.opacity = '1';
					markReadBtn.style.cursor = 'pointer';
					alert('<%= lang === "en" ? "Error marking as read" : "Erreur lors du marquage comme lu" %>');
				}
			} catch (error) {
				// Re-enable button on error
				markReadBtn.disabled = false;
				markReadBtn.style.opacity = '1';
				markReadBtn.style.cursor = 'pointer';
				console.error('Error:', error);
				alert('<%= lang === "en" ? "Error marking as read" : "Erreur lors du marquage comme lu" %>');
			}
		});
	}
	
	// Chart.js configuration
	const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
	const textColor = isDark ? '#e6edff' : '#1e293b';
	const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
	
	// Chart data from server
	const chartData = {
		compliantCount: <%= compliantCount || 0 %>,
		inProgressCount: <%= inProgressCount || 0 %>,
		nonCompliantCount: <%= nonCompliantCount || 0 %>,
		pendingCount: <%= pendingCount || 0 %>,
		compliantPercentage: <%= compliantPercentage || 0 %>,
		totalSuppliers: <%= totalSuppliers || 0 %>
	};
	
	// Status Distribution Chart (Doughnut)
	const statusCtx = document.getElementById('statusChart');
	if (statusCtx) {
		new Chart(statusCtx, {
			type: 'doughnut',
			data: {
				labels: [
					'<%= lang === "en" ? "Compliant" : "Conformes" %>',
					'<%= lang === "en" ? "In Progress" : "En cours" %>',
					'<%= lang === "en" ? "Non-Compliant" : "Non conformes" %>',
					'<%= lang === "en" ? "Pending" : "En attente" %>'
				],
				datasets: [{
					data: [
						chartData.compliantCount,
						chartData.inProgressCount,
						chartData.nonCompliantCount,
						chartData.pendingCount
					],
					backgroundColor: [
						'rgba(34, 197, 94, 0.8)',
						'rgba(245, 158, 11, 0.8)',
						'rgba(239, 68, 68, 0.8)',
						'rgba(148, 163, 184, 0.8)'
					],
					borderColor: [
						'rgba(34, 197, 94, 1)',
						'rgba(245, 158, 11, 1)',
						'rgba(239, 68, 68, 1)',
						'rgba(148, 163, 184, 1)'
					],
					borderWidth: 2
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: true,
				plugins: {
					legend: {
						position: 'bottom',
						labels: {
							color: textColor,
							padding: 12,
							font: {
								size: 12
							}
						}
					},
					tooltip: {
						backgroundColor: isDark ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255, 255, 255, 0.95)',
						titleColor: textColor,
						bodyColor: textColor,
						borderColor: gridColor,
						borderWidth: 1
					}
				}
			}
		});
	}
	
	// Compliance Rate Chart (Gauge/Progress)
	const complianceCtx = document.getElementById('complianceChart');
	if (complianceCtx) {
		new Chart(complianceCtx, {
			type: 'doughnut',
			data: {
				labels: [
					'<%= lang === "en" ? "Compliant" : "Conformes" %>',
					'<%= lang === "en" ? "Non-Compliant" : "Non conformes" %>'
				],
				datasets: [{
					data: [
						chartData.compliantPercentage,
						100 - chartData.compliantPercentage
					],
					backgroundColor: [
						'rgba(34, 197, 94, 0.8)',
						'rgba(239, 68, 68, 0.2)'
					],
					borderColor: [
						'rgba(34, 197, 94, 1)',
						'rgba(239, 68, 68, 0.3)'
					],
					borderWidth: 2
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: true,
				cutout: '70%',
				plugins: {
					legend: {
						display: false
					},
					tooltip: {
						enabled: false
					},
					datalabels: {
						display: false
					}
				}
			},
			plugins: [{
				id: 'centerText',
				beforeDraw: (chart) => {
					const ctx = chart.ctx;
					const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
					const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
					
					ctx.save();
					ctx.font = 'bold 32px Poppins';
					ctx.fillStyle = textColor;
					ctx.textAlign = 'center';
					ctx.textBaseline = 'middle';
					ctx.fillText(chartData.compliantPercentage + '%', centerX, centerY - 10);
					
					ctx.font = '14px Poppins';
					ctx.fillStyle = isDark ? '#aab7d6' : '#64748b';
					ctx.fillText('<%= lang === "en" ? "Compliant" : "Conformes" %>', centerX, centerY + 20);
					ctx.restore();
				}
			}]
		});
	}
	
	// Risks Chart (Bar)
	const risksCtx = document.getElementById('risksChart');
	if (risksCtx) {
		new Chart(risksCtx, {
			type: 'bar',
			data: {
				labels: [
					'<%= lang === "en" ? "Critical Risks" : "Risques critiques" %>',
					'<%= lang === "en" ? "In Progress" : "En cours" %>',
					'<%= lang === "en" ? "Pending" : "En attente" %>'
				],
				datasets: [{
					label: '<%= lang === "en" ? "Count" : "Nombre" %>',
					data: [
						chartData.nonCompliantCount,
						chartData.inProgressCount,
						chartData.pendingCount
					],
					backgroundColor: [
						'rgba(239, 68, 68, 0.8)',
						'rgba(245, 158, 11, 0.8)',
						'rgba(148, 163, 184, 0.8)'
					],
					borderColor: [
						'rgba(239, 68, 68, 1)',
						'rgba(245, 158, 11, 1)',
						'rgba(148, 163, 184, 1)'
					],
					borderWidth: 2,
					borderRadius: 6
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: true,
				scales: {
					y: {
						beginAtZero: true,
						ticks: {
							color: textColor,
							stepSize: 1
						},
						grid: {
							color: gridColor
						}
					},
					x: {
						ticks: {
							color: textColor
						},
						grid: {
							display: false
						}
					}
				},
				plugins: {
					legend: {
						display: false
					},
					tooltip: {
						backgroundColor: isDark ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255, 255, 255, 0.95)',
						titleColor: textColor,
						bodyColor: textColor,
						borderColor: gridColor,
						borderWidth: 1
					}
				}
			}
		});
	}
});
</script>
