<h2><%= supplier.name %></h2>
<p class="muted"><%= t('common.contact') %>: <%= supplier.contact_email || '-' %></p>
<p>
	<%= t('common.inviteLink') %>:
	<a href="<%= baseUrl %>/invite/<%= supplier.invite_token %>" target="_blank" style="margin-right:8px"><%= baseUrl %>/invite/<%= supplier.invite_token %></a>
	<button class="btn accent" type="button" data-copy="<%= baseUrl %>/invite/<%= supplier.invite_token %>"><%= t('common.copy') %></button>
</p>

<h3><%= t('common.assessments') %></h3>
<table class="table">
	<thead>
		<tr>
			<th><%= t('common.date') %></th>
			<th><%= t('common.score') %></th>
			<th><%= t('common.status') %></th>
			<th><%= t('validation.validationStatus') %></th>
			<th><%= t('common.details') %></th>
		</tr>
	</thead>
	<tbody>
		<% if (assessments.length === 0) { %>
			<tr><td colspan="5" class="muted"><%= t('common.noAssessments') %></td></tr>
		<% } %>
		<% assessments.forEach(a => { %>
			<tr data-assessment-row="<%= a.id %>">
				<td><%= new Date(a.created_at).toLocaleString() %></td>
				<td><%= a.score %>%</td>
				<td class="status-cell">
					<% 
					// Use statusKey to determine badge type (a.statusKey is set in app.js)
					const statusKey = a.statusKey || (a.status === 'COMPLIANT' || a.status === 'Conforme' || a.status === 'Compliant' ? 'COMPLIANT' 
						: (a.status === 'IN_PROGRESS' || a.status === 'En cours' || a.status === 'In Progress' ? 'IN_PROGRESS' : 'NON_COMPLIANT'));
					const isCompliant = statusKey === 'COMPLIANT';
					const isInProgress = statusKey === 'IN_PROGRESS';
					// Status text is already translated in app.js
					const statusText = a.status;
					%>
					<span class="badge <%= isCompliant ? 'ok' : (isInProgress ? 'warn' : 'err') %>">
						<% if (isCompliant) { %>
							<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><polyline points="20 6 9 17 4 12"/></svg>
						<% } else if (isInProgress) { %>
							<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
						<% } else { %>
							<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
						<% } %>
						<%= statusText %>
					</span>
				</td>
				<td>
					<% 
					const validationStatus = a.validation_status || 'PENDING';
					const validationStatusKey = ['PENDING', 'APPROVED', 'REJECTED', 'NEEDS_CLARIFICATION'].includes(validationStatus) ? validationStatus : 'PENDING';
					const validationStatusText = getValidationStatus(validationStatusKey, lang);
					%>
					<% if (validationStatusKey === 'PENDING') { %>
						<span class="badge warn" style="background:linear-gradient(180deg,rgba(154,52,18,.9),rgba(194,65,12,.7));">
							<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
							<%= validationStatusText %>
						</span>
					<% } else if (validationStatusKey === 'APPROVED') { %>
						<span class="badge ok">
							<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><polyline points="20 6 9 17 4 12"/></svg>
							<%= validationStatusText %>
						</span>
					<% } else if (validationStatusKey === 'REJECTED') { %>
						<span class="badge err">
							<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
							<%= validationStatusText %>
						</span>
					<% } else { %>
						<span class="badge warn">
							<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
							<%= validationStatusText %>
						</span>
					<% } %>
				</td>
				<td>
					<button class="btn-view-details" type="button" data-assessment-id="<%= a.id %>" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500"><%= t('common.viewDetails') %></button>
				</td>
			</tr>
			<tr class="details-row" id="details-row-<%= a.id %>" hidden>
				<td colspan="5" style="padding:0;border:none">
					<div class="assessment-details">
						<% const answers = JSON.parse(a.answers_json || '{}'); const proofs = JSON.parse(a.proofs_json || '{}'); %>
						<% 
						// Reuse validationStatus and validationStatusKey from the loop above
						const detailValidationStatus = a.validation_status || 'PENDING';
						const detailValidationStatusKey = ['PENDING', 'APPROVED', 'REJECTED', 'NEEDS_CLARIFICATION'].includes(detailValidationStatus) ? detailValidationStatus : 'PENDING';
						%>
						
						<!-- Validation Info (if validated) -->
						<% if (detailValidationStatusKey === 'APPROVED' || detailValidationStatusKey === 'REJECTED' || detailValidationStatusKey === 'NEEDS_CLARIFICATION') { %>
							<div class="validation-info" style="background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px">
								<h4 style="margin-top:0;margin-bottom:12px"><%= t('validation.validationInfo') %></h4>
								<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px">
									<div>
										<strong><%= t('validation.validatedBy') %>:</strong> <%= a.validated_by || '-' %>
									</div>
									<div>
										<strong><%= t('validation.validatedAt') %>:</strong> <%= a.validated_at ? new Date(a.validated_at).toLocaleString() : '-' %>
									</div>
									<div>
										<strong><%= t('validation.status') %>:</strong> 
										<span class="badge <%= detailValidationStatusKey === 'APPROVED' ? 'ok' : (detailValidationStatusKey === 'REJECTED' ? 'err' : 'warn') %>" style="margin-left:8px">
											<%= getValidationStatus(detailValidationStatusKey, lang) %>
										</span>
									</div>
								</div>
								<% if (a.validation_comments) { %>
									<div style="margin-top:12px">
										<strong><%= t('validation.comments') %>:</strong>
										<div style="background:rgba(255,255,255,.02);padding:12px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,.05)">
											<%= a.validation_comments.replace(/\n/g, '<br>') %>
										</div>
									</div>
								<% } %>
							</div>
						<% } %>
						
						<!-- Validation Actions (if pending) -->
						<% if (detailValidationStatusKey === 'PENDING' || detailValidationStatusKey === 'NEEDS_CLARIFICATION') { %>
							<div class="validation-actions" style="background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px">
								<h4 style="margin-top:0;margin-bottom:12px"><%= t('validation.validateAssessment') %></h4>
								<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">
									<!-- Approve Form -->
									<form method="post" action="<%= urlWithLang('/assessments/' + a.id + '/approve') %>" style="display:flex;flex-direction:column;gap:8px">
										<label style="font-weight:600;margin-bottom:4px"><%= t('validation.approve') %></label>
										<textarea name="comments" placeholder="<%= t('validation.commentsPlaceholder') %>" rows="3" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text);font-family:inherit;resize:vertical"></textarea>
										<select name="manual_status" class="status-select" style="margin-top:4px">
											<option value=""><%= t('validation.useCalculatedStatus') %></option>
											<option value="COMPLIANT"><%= getStatus('COMPLIANT', lang) %></option>
											<option value="IN_PROGRESS"><%= getStatus('IN_PROGRESS', lang) %></option>
											<option value="NON_COMPLIANT"><%= getStatus('NON_COMPLIANT', lang) %></option>
										</select>
										<button type="submit" class="btn ok" style="margin-top:4px;width:100%">
											<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><polyline points="20 6 9 17 4 12"/></svg>
											<%= t('validation.approve') %>
										</button>
									</form>
									
									<!-- Reject Form -->
									<form method="post" action="<%= urlWithLang('/assessments/' + a.id + '/reject') %>" style="display:flex;flex-direction:column;gap:8px">
										<label style="font-weight:600;margin-bottom:4px"><%= t('validation.reject') %></label>
										<textarea name="comments" placeholder="<%= t('validation.rejectReasonRequired') %>" rows="3" required style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text);font-family:inherit;resize:vertical"></textarea>
										<button type="submit" class="btn err" style="margin-top:4px;width:100%">
											<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
											<%= t('validation.reject') %>
										</button>
									</form>
									
									<!-- Request Clarification Form -->
									<form method="post" action="<%= urlWithLang('/assessments/' + a.id + '/request-clarification') %>" style="display:flex;flex-direction:column;gap:8px">
										<label style="font-weight:600;margin-bottom:4px"><%= t('validation.requestClarification') %></label>
										<textarea name="comments" placeholder="<%= t('validation.clarificationRequest') %>" rows="3" required style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text);font-family:inherit;resize:vertical"></textarea>
										<button type="submit" class="btn warn" style="margin-top:4px;width:100%">
											<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
											<%= t('validation.requestClarification') %>
										</button>
									</form>
								</div>
							</div>
						<% } %>
						
						<!-- Assessment Details -->
						<div class="details-content">
							<h4 style="margin-top:0;margin-bottom:12px"><%= t('assessment.questions') %></h4>
							<% QUESTIONS.forEach(q => { %>
								<div class="detail-item">
									<div class="detail-question">
										<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:8px;color:#93c5fd">
											<circle cx="12" cy="12" r="10"/>
											<path d="M12 16v-4"/>
											<path d="M12 8h.01"/>
										</svg>
										<span><%= q.text %></span>
									</div>
									<div class="detail-answer">
										<% const answer = (answers[q.id] || '').toLowerCase(); %>
										<% if (answer === 'yes') { %>
											<span class="answer-badge yes">
												<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
												<%= t('common.yes') %>
											</span>
										<% } else if (answer === 'no') { %>
											<span class="answer-badge no">
												<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
												<%= t('common.no') %>
											</span>
										<% } else { %>
											<span class="answer-badge na"><%= t('common.na') %></span>
										<% } %>
										<% if (proofs[q.id]) { %>
											<% 
											// Check if it's a base64 data URL (Vercel) or file path (local)
											const isBase64 = proofs[q.id].startsWith('data:');
											const proofUrl = isBase64 ? urlWithLang(`/proof/${a.id}/${q.id}`) : proofs[q.id];
											%>
											<a href="<%= proofUrl %>" target="_blank" class="proof-link">
												<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
												<%= t('common.viewProof') %>
											</a>
										<% } %>
									</div>
								</div>
							<% }) %>
						</div>
					</div>
				</td>
			</tr>
		<% }) %>
	</tbody>
</table>

<script>
document.addEventListener('DOMContentLoaded', function() {
	const detailButtons = document.querySelectorAll('.btn-view-details');
	
	detailButtons.forEach(btn => {
		btn.addEventListener('click', function() {
			const assessmentId = this.getAttribute('data-assessment-id');
			const detailsRow = document.getElementById('details-row-' + assessmentId);
			
			if (detailsRow.hidden) {
				// Fermer tous les autres détails ouverts
				document.querySelectorAll('.details-row').forEach(row => {
					if (!row.hidden && row.id !== 'details-row-' + assessmentId) {
						row.hidden = true;
						row.style.display = 'none';
						const otherBtn = document.querySelector(`[data-assessment-id="${row.id.replace('details-row-', '')}"]`);
						if (otherBtn) otherBtn.textContent = 'Voir les détails';
					}
				});
				
				// Ouvrir les détails sélectionnés
				detailsRow.hidden = false;
				detailsRow.style.display = 'table-row';
				this.textContent = '<%= t("common.hideDetails") %>';
			} else {
				// Fermer les détails
				detailsRow.hidden = true;
				detailsRow.style.display = 'none';
				this.textContent = '<%= t("common.viewDetails") %>';
			}
		});
	});
});
</script>
